LIBRARY IEEE;
USE IEEE.STD_LOGIC_1164.ALL;
USE IEEE.STD_LOGIC_UNSIGNED.ALL;
USE IEEE.STD_LOGIC_ARITH.ALL;

ENTITY VIRTUAL_DY IS
	PORT
	(
		nRST				: in std_logic;
		clk					: in std_logic;

		gen_en_sensor		: in std_logic;
		default_out			: in std_logic;
		
		sensor_cycle		: in std_logic_vector(63 downto 0);
		sensor_valid_time	: in std_logic_vector(31 downto 0);
		SPR_XRawCoor		: in std_logic_vector(63 downto 0);			
			
		gen_dy				: out std_logic	
	);
END ENTITY;
	
ARCHITECTURE BEHV OF VIRTUAL_SENSOR	IS

signal gen_dy_cnt			: std_logic_vector(31 downto 0);  		
signal Pre_SPR_XRawCoor		: std_logic_vector(63 downto 0) := (others => '0');	
signal trigger				: std_logic := '0';
	
BEGIN
	process(clk, gen_en_sensor, nRST,default_out)
	begin
		if(clk'event and clk = '1') then
			if(nRST = '0') then
				gen_dy_cnt			<= (others => '0');
				Pre_SPR_XRawCoor 	<= SPR_XRawCoor;
				trigger				<= '0';
				gen_dy 				<= default_out;	
			else	
				if(SPR_XRawCoor - Pre_SPR_XRawCoor >= sensor_cycle) then
					Pre_SPR_XRawCoor	<= SPR_XRawCoor;
					trigger				<=  '1';
				end if;
			
				if(trigger = '1') then
					if(gen_dy_cnt < sensor_valid_time) then		-- edge is 100us 
						gen_dy_cnt 	<= gen_dy_cnt + '1';
						gen_dy		<= not default_out; 
					else
						gen_dy_cnt 	<= (others => '0');
						gen_dy		<= default_out; 
						trigger		<= '0';
					end if;	
				
				end if;
			end if;
		end if;
	end process;
	
END BEHV;